<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CV Generator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
</head>

<body class="bg-gray-100">
    <div class="flex h-screen overflow-hidden relative">    <!-- New Collapsible Sidebar -->
    <%- include('../partials/admin-sidebar', { adminID: 'admin123', currentPage: '/admin/cvGenerator.html' }) %>

    <!-- Overlay for mobile sidebar -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto">
      <div class="p-4 md:p-6">
        <!-- Header with mobile menu indicator -->
        <div class="flex justify-between items-center mb-6 md:mb-8">
          <div class="flex items-center">
            <button id="mobile-menu-button" class="mr-3 text-gray-700 md:hidden">
              <i class="fas fa-bars text-xl"></i>
            </button>
            <h1 class="text-xl md:text-2xl font-bold text-gray-800">
              Curriculum Vitae Generator
            </h1>
          </div>
          <div class="flex items-center space-x-2 md:space-x-4">
            <span class="text-gray-700 text-sm md:text-base hidden sm:inline">Profile</span>
            <div
              class="w-8 h-8 md:w-10 md:h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-800 font-semibold">
              S
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-1 gap-4 md:gap-6 mb-6 md:mb-8">
          <!-- CV Generator Card -->
          <div
            class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden transition-all duration-300 hover:shadow-lg">
            <div class="bg-blue-800 text-white p-4 md:p-5">
              <h2 class="text-lg md:text-xl font-semibold flex items-center">
                <i class="fas fa-file-alt mr-2 md:mr-3 text-xl md:text-2xl"></i>
                Prof. Sandeep Chaudhary's CV Generator
              </h2>
            </div>
            <div class="p-6 md:p-8 text-center">
              <p class="text-gray-600 mb-8 max-w-2xl mx-auto">
                Generate and download Prof. Sandeep Chaudhary's CV in PDF format. The document includes publications, books, book chapters, conference proceedings, patents, research projects, and supervised dissertations.
              </p>
              
              <button id="downloadCV" class="inline-flex items-center px-6 py-3 bg-green-600 text-white font-medium rounded-md hover:bg-green-700 transition-colors duration-300 shadow-md">
                <i class="fas fa-download mr-2"></i>
                Generate & Download CV
              </button>
              
              <div class="mt-6">
                <div id="loading" class="hidden mx-auto w-10 h-10 border-4 border-blue-200 border-t-blue-800 rounded-full animate-spin"></div>
                
                <div id="status" class="hidden mt-4 p-4 rounded-md text-center max-w-md mx-auto"></div>
              </div>
            </div>
          </div>
          
          <!-- Actions Bar -->
          <div class="flex justify-end mb-6 space-x-4 sticky top-0 z-20 bg-gray-100 py-4">
              <button id="saveConfigBtn" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 shadow-md flex items-center">
                  <i class="fas fa-save mr-2"></i> Save Configuration
              </button>
          </div>

          <!-- Loading & Status -->
          <div id="loading" class="hidden text-center py-4">
              <div class="w-10 h-10 border-4 border-blue-200 border-t-blue-800 rounded-full animate-spin mx-auto mb-2"></div>
              <p class="text-gray-600">Processing...</p>
          </div>
          <div id="status" class="hidden mb-6 p-4 rounded-md text-center"></div>

          <!-- Form Container -->
          <div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden">
            
            <!-- No Tabs, Single Linear Flow -->
            <div class="p-6 space-y-10">
                
                <!-- 1. Personal Information -->
                <div>
                    <h3 class="text-lg font-bold text-gray-800 border-b pb-2 mb-4">1. Personal Information</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium text-gray-700">Name</label><input type="text" id="pi_name" class="w-full border p-2 rounded"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Designation</label><textarea id="pi_designation" class="w-full border p-2 rounded" rows="2"></textarea></div>
                        <div><label class="block text-sm font-medium text-gray-700">Email</label><input type="text" id="pi_email" class="w-full border p-2 rounded"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Mobile</label><input type="text" id="pi_mobile" class="w-full border p-2 rounded"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Office Number</label><input type="text" id="pi_phone" class="w-full border p-2 rounded"></div>
                        <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700">Address</label><textarea id="pi_address" class="w-full border p-2 rounded" rows="3"></textarea></div>
                    </div>
                </div>

                <!-- 2. Qualifications -->
                <div>
                    <label class="block text-lg font-bold text-gray-800 border-b pb-2 mb-4">2. Academic & Research Qualifications</label>
                    <p class="text-xs text-gray-500 mb-2">Format: Degree - Institute (Year) - Details</p>
                    <textarea id="txt_qualifications" rows="4" class="w-full border p-2 rounded font-mono text-sm"></textarea>
                </div>

                <!-- 3. Work Experience -->
                <div>
                    <label class="block text-lg font-bold text-gray-800 border-b pb-2 mb-4">3. Work Experience</label>
                    <textarea id="txt_experience" rows="4" class="w-full border p-2 rounded font-mono text-sm"></textarea>
                </div>

                <!-- 4. Specialization -->
                <div>
                    <label class="block text-lg font-bold text-gray-800 border-b pb-2 mb-4">4. Specialization</label>
                    <textarea id="specialization" rows="3" class="w-full border p-2 rounded"></textarea>
                </div>

                <!-- 5. Research Credentials -->
                <div>
                    <h3 class="text-lg font-bold text-gray-800 border-b pb-2 mb-4">5. Research Credentials (Summary)</h3>
                    <div class="flex justify-between items-end mb-2">
                        <p class="text-sm text-gray-500">Auto-calculated counts. Edit manually if needed.</p>
                        <button type="button" onclick="populateCredentialsFromDB()" class="text-sm bg-blue-50 text-blue-600 px-3 py-1 rounded hover:bg-blue-100">Reset to DB Values</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-50 p-4 rounded border">
                        <div><label class="block text-xs font-medium text-gray-600">Tech Transfer/Translational</label><input type="text" id="rc_techTransfer" class="w-full border p-1 rounded text-sm" placeholder="e.g. 01/02"></div>
                        <div><label class="block text-xs font-medium text-gray-600">Patents (Granted/Pub/Filed/Process)</label><input type="text" id="rc_patents" class="w-full border p-1 rounded text-sm" placeholder="e.g. 02/02/01/01"></div>
                        <div><label class="block text-xs font-medium text-gray-600">SCIE/Scopus Journals</label><input type="text" id="rc_journals" class="w-full border p-1 rounded text-sm" placeholder="e.g. 119"></div>
                        <div><label class="block text-xs font-medium text-gray-600">Conference Proceedings</label><input type="text" id="rc_conferences" class="w-full border p-1 rounded text-sm" placeholder="e.g. 76"></div>
                        <div><label class="block text-xs font-medium text-gray-600">Books Authored/Edited</label><input type="text" id="rc_books" class="w-full border p-1 rounded text-sm" placeholder="e.g. 08"></div>
                        <div><label class="block text-xs font-medium text-gray-600">Technical Reports</label><input type="text" id="rc_technicalReports" class="w-full border p-1 rounded text-sm" placeholder="e.g. 01"></div>
                        <div><label class="block text-xs font-medium text-gray-600">Book/Video Chapters</label><input type="text" id="rc_chapters" class="w-full border p-1 rounded text-sm" placeholder="e.g. 05"></div>
                        <div><label class="block text-xs font-medium text-gray-600">Ph.D. Supervision (Comp/Ongoing)</label><input type="text" id="rc_phdSupervision" class="w-full border p-1 rounded text-sm" placeholder="e.g. 15/08"></div>
                        <div><label class="block text-xs font-medium text-gray-600">MTech/MSc Thesis (Awarded/Ongoing)</label><input type="text" id="rc_mtechSupervision" class="w-full border p-1 rounded text-sm" placeholder="e.g. 39/06"></div>
                        <div><label class="block text-xs font-medium text-gray-600">Sponsored Projects (Total)</label><input type="text" id="rc_sponsoredProjects" class="w-full border p-1 rounded text-sm" placeholder="e.g. 27"></div>
                        <div class="md:col-span-2"><label class="block text-xs font-medium text-gray-600">Project Roles Breakdown (PI/SD/Mentor/Co-PI/Guide)</label><input type="text" id="rc_projectRoles" class="w-full border p-1 rounded text-sm" placeholder="e.g. (13/01/05/02/06)"></div>
                    </div>
                </div>

                <!-- 6. Courses Taught -->
                <div>
                     <label class="block text-lg font-bold text-gray-800 border-b pb-2 mb-4">6. Courses Taught</label>
                     <textarea id="coursesTaught" rows="3" class="w-full border p-2 rounded"></textarea>
                </div>

                <!-- 7. Awards -->
                <div>
                    <label class="block text-lg font-bold text-gray-800 border-b pb-2 mb-4">7. Awards/ Achievements</label>
                    <textarea id="awards" rows="3" class="w-full border p-2 rounded"></textarea>
                </div>

                <!-- 8. Projects (Grouped) -->
                <div class="space-y-4">
                    <h4 class="text-lg font-bold text-gray-800">8. List of sponsored research projects</h4>
                    
                    <!-- PI -->
                    <div class="ml-4">
                        <div class="flex justify-between items-center mb-1">
                            <h5 class="font-semibold text-gray-700">As Principal Investigator</h5>
                            <div class="flex items-center gap-2">
                               <label class="text-xs flex items-center cursor-pointer"><input type="checkbox" onchange="toggleAll('list-projects-pi', this.checked)" class="mr-1">Select All</label>
                            </div>
                        </div>
                        <div id="list-projects-pi" class="border rounded h-32 overflow-y-auto p-2 bg-gray-50 space-y-1">Loading...</div>
                    </div>

                    <!-- Co-PI -->
                    <div class="ml-4">
                        <div class="flex justify-between items-center mb-1">
                            <h5 class="font-semibold text-gray-700">As Co-Principal Investigator</h5>
                            <div class="flex items-center gap-2">
                               <label class="text-xs flex items-center cursor-pointer"><input type="checkbox" onchange="toggleAll('list-projects-copi', this.checked)" class="mr-1">Select All</label>
                            </div>
                        </div>
                        <div id="list-projects-copi" class="border rounded h-32 overflow-y-auto p-2 bg-gray-50 space-y-1">Loading...</div>
                    </div>

                    <!-- Scientific Director -->
                    <div class="ml-4">
                        <div class="flex justify-between items-center mb-1">
                            <h5 class="font-semibold text-gray-700">As Scientific Director</h5>
                            <div class="flex items-center gap-2">
                               <label class="text-xs flex items-center cursor-pointer"><input type="checkbox" onchange="toggleAll('list-projects-sd', this.checked)" class="mr-1">Select All</label>
                            </div>
                        </div>
                        <div id="list-projects-sd" class="border rounded h-32 overflow-y-auto p-2 bg-gray-50 space-y-1">Loading...</div>
                    </div>

                    <!-- Mentor -->
                    <div class="ml-4">
                        <div class="flex justify-between items-center mb-1">
                            <h5 class="font-semibold text-gray-700">As Scientist Mentor</h5>
                            <div class="flex items-center gap-2">
                               <label class="text-xs flex items-center cursor-pointer"><input type="checkbox" onchange="toggleAll('list-projects-mentor', this.checked)" class="mr-1">Select All</label>
                            </div>
                        </div>
                        <div id="list-projects-mentor" class="border rounded h-32 overflow-y-auto p-2 bg-gray-50 space-y-1">Loading...</div>
                    </div>

                    <!-- Guide -->
                     <div class="ml-4">
                        <div class="flex justify-between items-center mb-1">
                            <h5 class="font-semibold text-gray-700">As a Guide</h5>
                            <div class="flex items-center gap-2">
                               <label class="text-xs flex items-center cursor-pointer"><input type="checkbox" onchange="toggleAll('list-projects-guide', this.checked)" class="mr-1">Select All</label>
                            </div>
                        </div>
                        <div id="list-projects-guide" class="border rounded h-32 overflow-y-auto p-2 bg-gray-50 space-y-1">Loading...</div>
                    </div>
                </div>

                <!-- 9. Patents -->
                <div class="selector-group">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-lg font-bold text-gray-800">9. Patents</h4>
                        <div class="flex items-center gap-2">
                           <label class="text-xs flex items-center cursor-pointer"><input type="checkbox" onchange="toggleAll('list-patents', this.checked)" class="mr-1">Select All</label>
                           <input type="text" onkeyup="filterList('list-patents', this.value)" placeholder="Search..." class="border p-1 rounded text-sm w-48">
                        </div>
                    </div>
                    <div id="list-patents" class="border rounded h-48 overflow-y-auto p-2 bg-gray-50 space-y-1">Loading...</div>
                </div>

                <!-- 10. List of publications -->
                <div>
                     <h4 class="text-lg font-bold text-gray-800 border-b pb-2 mb-4">10. List of publications</h4>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                         <div>
                             <div class="flex justify-between items-center mb-2">
                                 <h4 class="font-semibold">Books Published <span id="count-books" class="text-gray-500 font-normal">(0)</span></h4>
                                 <div class="flex items-center gap-2">
                                    <label class="text-xs flex items-center cursor-pointer"><input type="checkbox" onchange="toggleAll('list-books', this.checked)" class="mr-1">All</label>
                                    <input type="text" onkeyup="filterList('list-books', this.value)" placeholder="Search..." class="border p-1 text-xs w-32 rounded">
                                 </div>
                             </div>
                             <div id="list-books" class="border rounded h-40 overflow-y-auto p-2 bg-gray-50 space-y-1"></div>
                         </div>
                         <div>
                             <div class="flex justify-between items-center mb-2">
                                 <h4 class="font-semibold">SCI/ SCI-E Journal Publications <span id="count-journals" class="text-gray-500 font-normal">(0)</span></h4>
                                 <div class="flex items-center gap-2">
                                    <label class="text-xs flex items-center cursor-pointer"><input type="checkbox" onchange="toggleAll('list-journals', this.checked)" class="mr-1">All</label>
                                    <input type="text" onkeyup="filterList('list-journals', this.value)" placeholder="Search..." class="border p-1 text-xs w-32 rounded">
                                 </div>
                             </div>
                             <div id="list-journals" class="border rounded h-40 overflow-y-auto p-2 bg-gray-50 space-y-1"></div>
                         </div>
                         <div>
                             <div class="flex justify-between items-center mb-2">
                                 <h4 class="font-semibold">Conference publications <span id="count-conferences" class="text-gray-500 font-normal">(0)</span></h4>
                                 <div class="flex items-center gap-2">
                                    <label class="text-xs flex items-center cursor-pointer"><input type="checkbox" onchange="toggleAll('list-conferences', this.checked)" class="mr-1">All</label>
                                    <input type="text" onkeyup="filterList('list-conferences', this.value)" placeholder="Search..." class="border p-1 text-xs w-32 rounded">
                                 </div>
                             </div>
                             <div id="list-conferences" class="border rounded h-40 overflow-y-auto p-2 bg-gray-50 space-y-1"></div>
                         </div>
                         <div>
                             <div class="flex justify-between items-center mb-2">
                                 <h4 class="font-semibold">Chapters/Video Chapters Published <span id="count-chapters" class="text-gray-500 font-normal">(0)</span></h4>
                                 <div class="flex items-center gap-2">
                                    <label class="text-xs flex items-center cursor-pointer"><input type="checkbox" onchange="toggleAll('list-chapters', this.checked)" class="mr-1">All</label>
                                    <input type="text" onkeyup="filterList('list-chapters', this.value)" placeholder="Search..." class="border p-1 text-xs w-32 rounded">
                                 </div>
                             </div>
                             <div id="list-chapters" class="border rounded h-40 overflow-y-auto p-2 bg-gray-50 space-y-1"></div>
                         </div>
                     </div>
                </div>

                <!-- 11. Translational Contributions -->
                <div>
                     <h3 class="text-lg font-bold text-gray-800 border-b pb-2 mb-4">11. Translational Contributions</h3>
                     
                     <!-- Custom Items -->
                     <div class="mb-6 bg-gray-50 p-4 rounded border">
                        <label class="block font-medium mb-1">Custom Contributions</label>
                        <p class="text-xs text-gray-500 mb-2">Add contributions with Title and Description.</p>
                        <div id="container-trans-custom" class="space-y-4 mb-2"></div>
                        <button type="button" onclick="addTranslationalItem()" class="text-sm bg-green-50 text-green-600 px-3 py-1 rounded border border-green-200 hover:bg-green-100">+ Add Contribution</button>
                    </div>


                </div>

                <!-- 12. Professional Affiliations -->
                <div>
                    <label class="block text-lg font-bold text-gray-800 border-b pb-2 mb-4">12. Professional Affiliations</label>
                    <textarea id="affiliations" rows="3" class="w-full border p-2 rounded"></textarea>
                </div>

                <!-- 13. Admin Positions -->
                <div>
                    <label class="block text-lg font-bold text-gray-800 border-b pb-2 mb-4">13. Administrative Positions Held</label>
                    <textarea id="txt_adminPositions" rows="4" class="w-full border p-2 rounded font-mono text-sm"></textarea>
                </div>

                <!-- 14. Facilities -->
                <div>
                    <label class="block text-lg font-bold text-gray-800 border-b pb-2 mb-4">14. Facilities and Centres established</label>
                    <textarea id="facilities" rows="3" class="w-full border p-2 rounded"></textarea>
                </div>

                <!-- 15. Workshops, Conferences -->
                <div>
                    <label class="block text-lg font-bold text-gray-800 border-b pb-2 mb-4">15. Conferences Organised</label>
                    
                    <!-- Organized Conferences Selector -->
                    <div class="selector-group mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-semibold text-gray-700">Conferences Organised</h4>
                            <div class="flex items-center gap-2">
                               <label class="text-xs flex items-center cursor-pointer"><input type="checkbox" onchange="toggleAll('list-organized-conferences', this.checked)" class="mr-1">Select All</label>
                               <input type="text" onkeyup="filterList('list-organized-conferences', this.value)" placeholder="Search..." class="border p-1 rounded text-sm w-48">
                            </div>
                        </div>
                        <div id="list-organized-conferences" class="border rounded h-40 overflow-y-auto p-2 bg-gray-50 space-y-1">Loading...</div>
                    </div>
                </div>

                <!-- 16. Continuing Education -->
                <!-- 16. Continuing Education -->
                <div>
                    <label class="block text-lg font-bold text-gray-800 border-b pb-2 mb-4">16. Workshops Organised</label>
                    <div class="selector-group mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-semibold text-gray-700">Workshops Organised</h4>
                            <div class="flex items-center gap-2">
                               <label class="text-xs flex items-center cursor-pointer"><input type="checkbox" onchange="toggleAll('list-cont-education', this.checked)" class="mr-1">Select All</label>
                               <input type="text" onkeyup="filterList('list-cont-education', this.value)" placeholder="Search..." class="border p-1 rounded text-sm w-48">
                            </div>
                        </div>
                        <div id="list-cont-education" class="border rounded h-40 overflow-y-auto p-2 bg-gray-50 space-y-1">Loading...</div>
                    </div>
                </div>

                <!-- 17. Collaborations -->
                <div>
                    <label class="block text-lg font-bold text-gray-800 border-b pb-2 mb-4">17. International Collaborations</label>
                    <textarea id="collaborations" rows="3" class="w-full border p-2 rounded"></textarea>
                </div>

                <!-- 18. Outreach -->
                <div class="selector-group space-y-4">
                    <h4 class="text-lg font-bold text-gray-800 border-b pb-2">18. Major Outreach</h4>


                    <!-- Intl -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                             <h5 class="font-semibold text-gray-700">Contributions</h5>
                             <div class="flex items-center gap-2">
                                <label class="text-xs flex items-center cursor-pointer"><input type="checkbox" onchange="toggleAll('list-outreach-intl', this.checked)" class="mr-1">All</label>
                                <input type="text" onkeyup="filterList('list-outreach-intl', this.value)" placeholder="Search..." class="border p-1 rounded text-xs w-32">
                             </div>
                        </div>
                        <div id="list-outreach-intl" class="border rounded h-32 overflow-y-auto p-2 bg-gray-50 space-y-1"></div>
                    </div>

                    <!-- Natl -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                             <h5 class="font-semibold text-gray-700">Government Advisory Roles</h5>
                             <div class="flex items-center gap-2">
                                <label class="text-xs flex items-center cursor-pointer"><input type="checkbox" onchange="toggleAll('list-outreach-natl', this.checked)" class="mr-1">All</label>
                                <input type="text" onkeyup="filterList('list-outreach-natl', this.value)" placeholder="Search..." class="border p-1 rounded text-xs w-32">
                             </div>
                        </div>
                        <div id="list-outreach-natl" class="border rounded h-32 overflow-y-auto p-2 bg-gray-50 space-y-1"></div>
                    </div>
                </div>

            </div>
          </div>

  <script>
    // --- UI Logic ---
    // --- UI Logic ---
    // switchTab removed as we now have a single linear view.

    function toggleAll(listId, checked) {
        const list = document.getElementById(listId);
        // Only toggle visible items if search filter is active?
        // For simple Select All, usually selects all available checkboxes
        const checkboxes = list.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(cb => {
            // Respect search filter: only toggle if parent label is displaying (not 'none')
            if(cb.parentElement.style.display !== 'none') {
                 cb.checked = checked;
            }
        });
    }

    function filterList(listId, query) {
        query = query.toLowerCase();
        const items = document.getElementById(listId).querySelectorAll('.select-item');
        items.forEach(item => {
            const text = item.textContent.toLowerCase();
            item.style.display = text.includes(query) ? 'flex' : 'none';
        });
    }

    function renderList(containerId, items, labelKey, idKey = '_id', preSelectedIds = []) {
        const container = document.getElementById(containerId);
        if (!items || items.length === 0) {
            container.innerHTML = '<p class="text-xs text-gray-500 p-2">No items found.</p>';
            return;
        }

        container.innerHTML = items.map(item => {
            const isChecked = preSelectedIds && preSelectedIds.includes(item[idKey]) ? 'checked' : '';
            // Simplify label for display
             let label = item[labelKey];
             if(containerId.includes('project')) label = `${item.title} (${item.year})`;
             if(containerId.includes('patent')) label = item.title;
             if(containerId.includes('tech-transfers')) label = item.title;
             if(containerId.includes('pub') || containerId.includes('book') || containerId.includes('journal')) label = `${item.title} (${item.year})`;
                if(containerId.includes('organized-conferences') || containerId.includes('cont-education')) {
                  const formatDate = (d) => d ? new Date(d).getFullYear() : '';
                  label = `${item.title} of ${item.description || ''}`;
                  if(item.location) label += `, ${item.location}`;
                  if(item.startDate) label += ` (${formatDate(item.startDate)})`;
             }
             if(containerId.includes('outreach')) {
                  label = `[${item.role}] ${item.title} - ${item.description || ''}`;
             }

            return `
                <label class="select-item flex items-center p-2 hover:bg-gray-100 rounded cursor-pointer text-sm border-b border-gray-100 last:border-0">
                    <input type="checkbox" value="${item[idKey]}" class="mr-3 h-4 w-4 text-blue-600 rounded" ${isChecked}>
                    <span class="pr-2 line-clamp-2" title="${label}">${label}</span>
                </label>
            `;
        }).join('');
    }
    
    // --- Data Logic ---
    let allData = {};
    let currentConfig = {};

    async function init() {
        showStatus('Loading data...', 'info');
        try {
            // Fetch Config
            const configResp = await fetch('/api/cv-config');
            currentConfig = await configResp.json();
            
            // Popuate Text Fields
            populateTextFields();

            // Fetch All Data for Lists
            const dataResp = await fetch('/api/all-cv-data');
            allData = await dataResp.json();
            
            // Render Lists
            renderAllLists();
            
            showStatus('', 'none');
        } catch (error) {
            console.error(error);
            showStatus('Failed to load data.', 'error');
        }
    }

    function populateTextFields() {
        // Personal
        if(currentConfig.personalInfo) {
            document.getElementById('pi_name').value = currentConfig.personalInfo.name || '';
            document.getElementById('pi_designation').value = currentConfig.personalInfo.designation || '';
            document.getElementById('pi_email').value = currentConfig.personalInfo.email || '';
            document.getElementById('pi_mobile').value = currentConfig.personalInfo.mobile || '';
            document.getElementById('pi_phone').value = currentConfig.personalInfo.phone || '';
            document.getElementById('pi_address').value = currentConfig.personalInfo.address || '';
        }

        // Research Credentials (saved or default to calculated if config is empty)
        const rc = currentConfig.researchCredentials || {};
        const stats = allData.calculatedStats || {};
        
        document.getElementById('rc_techTransfer').value = rc.techTransfer || stats.techTransfer || '00/00';
        document.getElementById('rc_patents').value = rc.patents || stats.patents || '00/00/00/00';
        document.getElementById('rc_journals').value = rc.journals || stats.journals || '0';
        document.getElementById('rc_conferences').value = rc.conferences || stats.conferences || '0';
        document.getElementById('rc_books').value = rc.books || stats.books || '00';
        document.getElementById('rc_technicalReports').value = rc.technicalReports || stats.technicalReports || '01'; // Default
        document.getElementById('rc_chapters').value = rc.chapters || stats.chapters || '00';
        document.getElementById('rc_phdSupervision').value = rc.phdSupervision || stats.phdSupervision || '00/00';
        document.getElementById('rc_mtechSupervision').value = rc.mtechSupervision || stats.mtechSupervision || '00/00';
        document.getElementById('rc_sponsoredProjects').value = rc.sponsoredProjects || stats.sponsoredProjects || '0';
        document.getElementById('rc_projectRoles').value = rc.projectRoles || stats.projectRoles || '(00)';
        
        // Fixed Text
        document.getElementById('txt_qualifications').value = currentConfig.qualifications || '';
        document.getElementById('txt_experience').value = currentConfig.experience || '';
        document.getElementById('txt_adminPositions').value = currentConfig.adminPositions || '';

        // Editable Details
        document.getElementById('specialization').value = currentConfig.specialization || '';
        document.getElementById('coursesTaught').value = currentConfig.coursesTaught || '';
        document.getElementById('awards').value = currentConfig.awards || '';
        // document.getElementById('translational').value = currentConfig.translational || ''; // Removed single text
        
        // Populate Custom Translational Items
        document.getElementById('container-trans-custom').innerHTML = ''; // Clear first
        if(currentConfig.translationalCustom && currentConfig.translationalCustom.length > 0) {
            currentConfig.translationalCustom.forEach(item => addTranslationalItem(item.title, item.description));
        } else {
             // Maybe add one empty? Or none.
        }

        document.getElementById('affiliations').value = currentConfig.affiliations || '';
        document.getElementById('facilities').value = currentConfig.facilities || '';

        document.getElementById('collaborations').value = currentConfig.collaborations || '';
    }

    function addTranslationalItem(title = '', desc = '') {
        const container = document.getElementById('container-trans-custom');
        const id = Date.now();
        const div = document.createElement('div');
        div.className = "p-3 border rounded bg-gray-50 flex flex-col gap-2 relative trans-item";
        div.innerHTML = `
            <button type="button" onclick="this.parentElement.remove()" class="absolute top-2 right-2 text-red-500 hover:text-red-700 text-xs font-bold">âœ• Remove</button>
            <div>
                <label class="block text-xs font-bold text-gray-700">Title / Header</label>
                <input type="text" class="trans-title w-full border p-1 rounded text-sm" value="${title}" placeholder="e.g. Naturally Colored Bi-layer Bricks (2021-2022)">
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-700">Description (Paragraph)</label>
                <textarea class="trans-desc w-full border p-1 rounded text-sm" rows="3" placeholder="Description of the technology...">${desc}</textarea>
            </div>
        `;
        container.appendChild(div);
    }

    function populateCredentialsFromDB() {
        const stats = allData.calculatedStats || {};
        document.getElementById('rc_techTransfer').value = stats.techTransfer || '00/00';
        document.getElementById('rc_patents').value = stats.patents || '00/00/00/00';
        document.getElementById('rc_journals').value = stats.journals || '0';
        document.getElementById('rc_conferences').value = stats.conferences || '0';
        document.getElementById('rc_books').value = stats.books || '00';
        document.getElementById('rc_technicalReports').value = stats.technicalReports || '01';
        document.getElementById('rc_chapters').value = stats.chapters || '00';
        document.getElementById('rc_phdSupervision').value = stats.phdSupervision || '00/00';
        document.getElementById('rc_mtechSupervision').value = stats.mtechSupervision || '00/00';
        document.getElementById('rc_sponsoredProjects').value = stats.sponsoredProjects || '0';
        document.getElementById('rc_projectRoles').value = stats.projectRoles || '(00)';
    }

    function renderAllLists() {
        // Project Grouping Logic
        // Project Grouping Logic
        const pPI = [], pCoPI = [], pSD = [], pMentor = [], pGuide = [];
        allData.projects.forEach(p => {
             const r = p.role ? p.role.trim().toLowerCase() : '';
             if(['principal investigator', 'pi', 'as principal investigator'].includes(r)) pPI.push(p);
             else if(['co-principal investigator', 'co-pi', 'co-pi/co-guide', 'as co-principal investigator'].includes(r)) pCoPI.push(p);
             else if(['scientific director', 'as scientific director'].includes(r)) pSD.push(p);
             else if(['scientist mentor', 'mentor', 'as scientist mentor'].includes(r)) pMentor.push(p);
             else pGuide.push(p); // Catch-all "Other" => "As a Guide" as requested
        });

        renderList('list-projects-pi', pPI, 'title', '_id', currentConfig.selectedProjects);
        renderList('list-projects-copi', pCoPI, 'title', '_id', currentConfig.selectedProjects);
        renderList('list-projects-sd', pSD, 'title', '_id', currentConfig.selectedProjects);
        renderList('list-projects-mentor', pMentor, 'title', '_id', currentConfig.selectedProjects);
        renderList('list-projects-guide', pGuide, 'title', '_id', currentConfig.selectedProjects);

        renderList('list-patents', allData.patents, 'title', '_id', currentConfig.selectedPatents);
        renderList('list-books', allData.books, 'title', '_id', currentConfig.selectedBooks);
        renderList('list-journals', allData.publications.filter(p => !p.journal || p.journal !== 'Conference'), 'title', '_id', currentConfig.selectedJournals); 
        renderList('list-chapters', allData.chapters, 'chapterName', '_id', currentConfig.selectedChapters); 
        renderList('list-conferences', allData.conferences, 'title', '_id', currentConfig.selectedConferences); 

        // Filter Extension Activities
        // Only Outreach remains as list.
        // Relaxed filters to handle renames/variations (e.g. "Conferences" vs "Conference organised")
        // Mapping: Govt -> National. 
        // International -> Includes 'International' OR 'Contributions' (that isn't National/Govt) - to catch renamed "Contributions"
        const outreachIntl = allData.extensionActivities.filter(a => a.role && (a.role.toLowerCase().includes('international') || (a.role.toLowerCase().includes('contributions') && !a.role.toLowerCase().includes('national') && !a.role.toLowerCase().includes('government'))));
        const outreachNatl = allData.extensionActivities.filter(a => a.role && (a.role.toLowerCase().includes('national') || a.role.toLowerCase().includes('government')) && !a.role.toLowerCase().includes('international'));

        renderList('list-outreach-intl', outreachIntl, 'title', '_id', currentConfig.selectedOutreach);
        renderList('list-outreach-natl', outreachNatl, 'title', '_id', currentConfig.selectedOutreach);

        // Conferences/Workshops Organised
        const organizedConfs = allData.extensionActivities.filter(a => a.role && a.role.toLowerCase().includes('conference')); 
        renderList('list-organized-conferences', organizedConfs, 'title', '_id', currentConfig.selectedOrganizedConferences);

        const workshops = allData.extensionActivities.filter(a => a.role && a.role.toLowerCase().includes('workshop'));
        renderList('list-cont-education', workshops, 'title', '_id', currentConfig.selectedWorkshops);


        // Update Counts
        if(document.getElementById('count-books')) document.getElementById('count-books').innerText = `(${allData.books.length})`;
        if(document.getElementById('count-journals')) document.getElementById('count-journals').innerText = `(${allData.publications.length})`;
        if(document.getElementById('count-chapters')) document.getElementById('count-chapters').innerText = `(${allData.chapters.length})`;
        if(document.getElementById('count-conferences')) document.getElementById('count-conferences').innerText = `(${allData.conferences.length})`;
    }

    function collectFormData() {
        // Helper to get checked IDs
        const getIds = (listId) => {
            return Array.from(document.getElementById(listId).querySelectorAll('input:checked')).map(cb => cb.value);
        };

        return {
            personalInfo: {
                name: document.getElementById('pi_name').value.trim(),
                designation: document.getElementById('pi_designation').value.trim(),
                email: document.getElementById('pi_email').value.trim(),
                mobile: document.getElementById('pi_mobile').value.trim(),
                phone: document.getElementById('pi_phone').value.trim(),
                address: document.getElementById('pi_address').value.trim()
            },
            qualifications: document.getElementById('txt_qualifications').value,
            experience: document.getElementById('txt_experience').value,
            adminPositions: document.getElementById('txt_adminPositions').value,
            
            specialization: document.getElementById('specialization').value.trim(),
            coursesTaught: document.getElementById('coursesTaught').value.trim(),
            awards: document.getElementById('awards').value.trim(),
            // translational: document.getElementById('translational').value.trim(), // Removed
            affiliations: document.getElementById('affiliations').value.trim(),
            facilities: document.getElementById('facilities').value.trim(),
            collaborations: document.getElementById('collaborations').value.trim(),
            
            translationalCustom: getTranslationalItems(),

            researchCredentials: {
                techTransfer: document.getElementById('rc_techTransfer').value.trim(),
                patents: document.getElementById('rc_patents').value.trim(),
                journals: document.getElementById('rc_journals').value.trim(),
                conferences: document.getElementById('rc_conferences').value.trim(),
                books: document.getElementById('rc_books').value.trim(),
                technicalReports: document.getElementById('rc_technicalReports').value.trim(),
                chapters: document.getElementById('rc_chapters').value.trim(),
                phdSupervision: document.getElementById('rc_phdSupervision').value.trim(),
                mtechSupervision: document.getElementById('rc_mtechSupervision').value.trim(),
                sponsoredProjects: document.getElementById('rc_sponsoredProjects').value.trim(),
                projectRoles: document.getElementById('rc_projectRoles').value.trim()
            },

            selectedProjects: [
                ...getIds('list-projects-pi'),
                ...getIds('list-projects-copi'),
                ...getIds('list-projects-sd'),
                ...getIds('list-projects-mentor'),
                ...getIds('list-projects-guide')
            ],
            selectedPatents: getIds('list-patents'),
            selectedBooks: getIds('list-books'),
            selectedJournals: getIds('list-journals'),
            selectedChapters: getIds('list-chapters'),
            selectedConferences: getIds('list-conferences'),

            selectedOutreach: [
                ...getIds('list-outreach-intl'),
                ...getIds('list-outreach-natl')
            ],
            selectedOrganizedConferences: getIds('list-organized-conferences'),
            selectedWorkshops: getIds('list-cont-education')
        };
    }

    function getTranslationalItems() {
        const items = [];
        document.querySelectorAll('.trans-item').forEach(div => {
             const title = div.querySelector('.trans-title').value.trim();
             const desc = div.querySelector('.trans-desc').value.trim();
             if(title || desc) {
                 items.push({ title, description: desc });
             }
        });
        return items;
    }

    async function saveConfig() {
        const data = collectFormData();
        showStatus('Saving...', 'info');
        try {
            const response = await fetch('/api/cv-config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if(response.ok) {
                showStatus('Configuration saved successfully!', 'success');
                // Update local config reference
                currentConfig = data;
            } else {
                showStatus('Failed to save.', 'error');
            }
        } catch(e) {
            console.error(e);
            showStatus('Error saving configuration.', 'error');
        }
    }

    async function generateCV() {
        const data = collectFormData();
        showStatus('Generating CV...', 'info');
        document.getElementById('loading').classList.remove('hidden');

        try {
            // We send the FULL data payload, which acts as a save + generate
            const response = await fetch('/generate-cv', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if(response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'Sandeep_Chaudhary_CV.pdf';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                showStatus('CV Generated!', 'success');
            } else {
                showStatus('Failed to generate CV.', 'error');
            }
        } catch(e) {
            console.error(e);
            showStatus('Error generating CV.', 'error');
        } finally {
            document.getElementById('loading').classList.add('hidden');
        }
    }

    function showStatus(msg, type) {
        const el = document.getElementById('status');
        if(type === 'none') {
            el.classList.add('hidden');
            return;
        }
        el.textContent = msg;
        el.className = 'mb-6 p-4 rounded-md text-center ' + (type === 'error' ? 'bg-red-100 text-red-800' : (type === 'success' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'));
        el.classList.remove('hidden');
        
        if(type === 'success') setTimeout(() => el.classList.add('hidden'), 3000);
    }

    // Event Listeners
    document.getElementById('saveConfigBtn').addEventListener('click', saveConfig);
    document.getElementById('downloadCV').addEventListener('click', generateCV);

    // Init
    init();
  </script>
</body>

</html>
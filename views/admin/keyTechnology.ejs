<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Key Technologies Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
</head>

<body class="bg-gray-100 min-h-screen">
  <div class="flex h-screen overflow-hidden relative">    <!-- New Collapsible Sidebar -->
    <%- include('../partials/admin-sidebar', { adminID: 'admin123', currentPage: '/admin/keyTechnology.html' }) %>

    <!-- Overlay for mobile sidebar -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto">
      <div class="p-4 md:p-6">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
          <div class="flex items-center">
            <button id="mobile-menu-button" class="mr-3 text-gray-700 md:hidden">
              <i class="fas fa-bars text-xl"></i>
            </button>
            <h1 class="text-xl md:text-2xl font-bold text-gray-800">
              Key Technologies Management
            </h1>
          </div>
          <div class="flex items-center space-x-2 md:space-x-4">
            <span class="text-gray-700 text-sm md:text-base hidden sm:inline">Manage technologies shown on
              website</span>
            <div
              class="w-8 h-8 md:w-10 md:h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-800 font-semibold">
              K
            </div>
          </div>
        </div>

        <!-- Overview -->
        <div class="bg-white shadow-md rounded-lg p-4 sm:p-6 mb-6">
          <div class="flex flex-wrap items-center justify-between gap-4">
            <div>
              <h2 class="text-lg sm:text-xl font-semibold text-gray-800">Overview</h2>
              <p class="text-gray-600 mt-1">Add, update or remove key technologies displayed to users.</p>
            </div>
            <div class="flex flex-col items-end">
              <div class="text-3xl font-bold text-blue-600" id="techCount">0</div>
              <div class="text-sm text-gray-500">Total Technologies</div>
            </div>
          </div>
        </div>

        <!-- Form -->
        <div class="bg-white shadow-md rounded-lg p-4 sm:p-6 mb-6">
          <h2 class="text-lg font-semibold mb-4 text-gray-800">Add / Edit Key Technology</h2>
          <form id="techForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input type="hidden" id="techId" />

            <div class="flex flex-col">
              <label class="mb-2 text-gray-700" for="title">Title</label>
              <input type="text" id="title" name="title" required
                class="border border-gray-300 p-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" />
            </div>
            
            <div class="flex flex-col">
              <label class="mb-2 text-gray-700" for="order">Order (Preference)</label>
              <input type="number" id="order" name="order" value="0"
                class="border border-gray-300 p-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" />
               <p class="text-xs text-gray-500 mt-1">Lower numbers appear first (e.g. 1, 2, 3...)</p>
            </div>

            <div class="flex flex-col">
              <label class="mb-2 text-gray-700" for="image">Image Upload</label>
              <input type="file" id="image" name="image" accept="image/*"
                class="border border-gray-300 p-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" />
              <p class="text-xs text-gray-500 mt-1">Accepted formats: JPG, PNG, GIF, WEBP. Max size: 5MB.</p>
              <!-- Hidden input to store existing image URL during edits -->
              <input type="hidden" id="existingImageUrl" name="imageUrl">
              <div id="imagePreviewContainer" class="hidden mt-2">
                <p class="text-xs text-gray-600 mb-1">Current Image:</p>
                <img id="imagePreview" src="" alt="Preview" class="h-20 object-contain border rounded">
              </div>
            </div>

            <div class="flex flex-col md:col-span-2">
              <label class="mb-2 text-gray-700" for="description">Description</label>
              <textarea id="description" name="description" rows="4" required
                class="border border-gray-300 p-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
            </div>

            <div class="flex flex-col md:col-span-2">
              <label class="mb-2 text-gray-700" for="tags">Tags (comma separated)</label>
              <input type="text" id="tags" name="tags"
                placeholder="highlighted, industrial, lowcarbon, building, materials, waste, research, digital, rural, lightweight, simulation, instrument, patent"
                class="border border-gray-300 p-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" />
              <p class="text-xs text-gray-500 mt-1">
                Use these tags to match filters on the public page (e.g. <code>highlighted</code>,
                <code>industrial</code>, <code>lowcarbon</code>, <code>building</code>, <code>materials</code>,
                <code>waste</code>, <code>research</code>, <code>digital</code>, <code>rural</code>,
                <code>lightweight</code>, <code>simulation</code>, <code>instrument</code>, <code>patent</code>).
              </p>
            </div>

            <div class="col-span-1 md:col-span-2 flex flex-wrap gap-3">
              <button type="submit" id="addButton"
                class="flex-1 bg-blue-600 text-white p-3 rounded hover:bg-blue-700 transition duration-300 min-w-[150px]">
                <i class="fas fa-plus mr-2"></i> Add Technology
              </button>
              <button type="submit" id="updateButton"
                class="flex-1 bg-green-600 text-white p-3 rounded hover:bg-green-700 transition duration-300 hidden min-w-[150px]">
                <i class="fas fa-save mr-2"></i> Update Technology
              </button>
              <button type="button" id="cancelEditButton"
                class="flex-1 bg-gray-500 text-white p-3 rounded hover:bg-gray-600 transition duration-300 hidden min-w-[150px]">
                <i class="fas fa-times mr-2"></i> Cancel
              </button>
            </div>
          </form>
        </div>

        <!-- Technologies Grid -->
        <div class="bg-white shadow-md rounded-lg p-4 sm:p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold text-gray-800">Existing Technologies</h2>
            <input type="text" id="searchInput" placeholder="Search by title or tag..."
              class="border border-gray-300 p-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-56" />
          </div>
          <div id="techGrid"
            class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4 sm:gap-6 max-h-[55vh] overflow-y-auto">
            <!-- Cards injected via JS -->
          </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div id="deleteModal"
          class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
          <div class="bg-white rounded-lg p-6 max-w-sm w-full">
            <h2 class="text-xl font-bold mb-4 text-gray-800">Confirm Deletion</h2>
            <p class="mb-6 text-gray-600">
              Are you sure you want to delete this key technology?
            </p>
            <div class="flex space-x-4">
              <button id="confirmDeleteBtn"
                class="flex-1 bg-red-500 text-white p-3 rounded hover:bg-red-600 transition duration-300">
                <i class="fas fa-trash-alt mr-2"></i> Delete
              </button>
              <button id="cancelDeleteBtn"
                class="flex-1 bg-gray-500 text-white p-3 rounded hover:bg-gray-600 transition duration-300">
                <i class="fas fa-times mr-2"></i> Cancel
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Floating action button for mobile -->
  <button id="mobile-fab"
    class="md:hidden fixed bottom-4 right-4 bg-blue-600 text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg z-30">
    <i class="fas fa-plus"></i>
  </button>

  <script>
    const techForm = document.getElementById("techForm");
    const techGrid = document.getElementById("techGrid");
    const addButton = document.getElementById("addButton");
    const updateButton = document.getElementById("updateButton");
    const cancelEditButton = document.getElementById("cancelEditButton");
    const deleteModal = document.getElementById("deleteModal");
    const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
    const cancelDeleteBtn = document.getElementById("cancelDeleteBtn");
    const searchInput = document.getElementById("searchInput");
    const techCount = document.getElementById("techCount");

    const mobileMenuButton = document.getElementById("mobile-menu-button");
    const closeSidebarButton = document.getElementById("close-sidebar");
    const sidebar = document.getElementById("sidebar");
    const sidebarOverlay = document.getElementById("sidebar-overlay");
    const mobileFab = document.getElementById("mobile-fab");

    let technologies = [];
    let currentDeletingId = null;

    function openSidebar() {
      sidebar.classList.remove("-translate-x-full");
      sidebarOverlay.classList.remove("hidden");
      document.body.classList.add("overflow-hidden");
    }

    function closeSidebar() {
      sidebar.classList.add("-translate-x-full");
      sidebarOverlay.classList.add("hidden");
      document.body.classList.remove("overflow-hidden");
    }

    if (mobileMenuButton) {
      mobileMenuButton.addEventListener("click", openSidebar);
    }
    if (closeSidebarButton) {
      closeSidebarButton.addEventListener("click", closeSidebar);
    }
    if (sidebarOverlay) {
      sidebarOverlay.addEventListener("click", closeSidebar);
    }

    const sidebarLinks = sidebar.querySelectorAll("a");
    sidebarLinks.forEach((link) => {
      link.addEventListener("click", () => {
        if (window.innerWidth < 768) {
          closeSidebar();
        }
      });
    });

    if (mobileFab) {
      mobileFab.addEventListener("click", () => {
        const formElement = document.getElementById("techForm");
        if (formElement) {
          formElement.scrollIntoView({ behavior: "smooth" });
        }
      });
    }

    window.addEventListener("resize", () => {
      if (window.innerWidth >= 768) {
        sidebar.classList.remove("-translate-x-full");
        sidebarOverlay.classList.add("hidden");
        document.body.classList.remove("overflow-hidden");
      } else {
        sidebar.classList.add("-translate-x-full");
      }
    });

    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function renderTechnologies(list) {
      techCount.textContent = list.length;
      techGrid.innerHTML = list
        .map(
          (tech) => `
        <div class="bg-white shadow-md rounded-lg overflow-hidden flex flex-col">
          <div class="h-32 bg-gray-100 flex items-center justify-center overflow-hidden relative">
            <span class="absolute top-2 left-2 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded">Order: ${tech.order || 0}</span>
            <img src="${escapeHtml(tech.imageUrl || "")}" alt="${escapeHtml(
            tech.title || ""
          )}" class="object-contain max-h-full">
          </div>
          <div class="p-3 flex-1 flex flex-col">
            <h3 class="font-semibold text-gray-800 mb-1 line-clamp-2" title="${escapeHtml(
              tech.title || ""
            )}">${escapeHtml(tech.title || "")}</h3>
            <p class="text-xs text-gray-600 mb-2 line-clamp-3">${escapeHtml(
              tech.description || ""
            )}</p>
            <div class="flex flex-wrap gap-1 mb-3">
              ${(tech.tags || [])
                .map(
                  (tag) =>
                    `<span class="text-[10px] px-2 py-0.5 bg-blue-50 text-blue-700 rounded-full border border-blue-100">${escapeHtml(
                      tag
                    )}</span>`
                )
                .join("")}
            </div>
            <div class="mt-auto flex space-x-2">
              <button
                onclick="editTechnology('${tech._id}')"
                class="flex-1 bg-yellow-500 text-white text-sm py-2 rounded hover:bg-yellow-600 transition duration-300"
              >
                <i class="fas fa-edit mr-1"></i> Edit
              </button>
              <button
                onclick="confirmDelete('${tech._id}')"
                class="flex-1 bg-red-500 text-white text-sm py-2 rounded hover:bg-red-600 transition duration-300"
              >
                <i class="fas fa-trash-alt mr-1"></i> Delete
              </button>
            </div>
          </div>
        </div>
      `
        )
        .join("");
    }

    async function fetchTechnologies() {
      try {
        const res = await fetch("/api/key-technologies");
        if (!res.ok) throw new Error("Failed to fetch key technologies");
        technologies = await res.json();
        renderTechnologies(technologies);
      } catch (error) {
        console.error(error);
        technologies = [];
        renderTechnologies(technologies);
      }
    }

    techForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const id = document.getElementById("techId").value;
      const title = document.getElementById("title").value.trim();
      const description = document.getElementById("description").value.trim();
      const tags = document.getElementById("tags").value.trim();
      const order = document.getElementById("order").value;
      const imageInput = document.getElementById("image");
      const existingImageUrl = document.getElementById("existingImageUrl").value;

      if (!title || !description) {
        alert("Title and description are required.");
        return;
      }
      
      // Check if image is provided (either new file or existing url)
      if (!id && imageInput.files.length === 0) {
        alert("Please upload an image for the new technology.");
        return;
      }

      // Using FormData for file upload
      const formData = new FormData();
      formData.append("title", title);
      formData.append("description", description);
      formData.append("tags", tags);
      formData.append("order", order);
      
      if (imageInput.files.length > 0) {
        formData.append("image", imageInput.files[0]);
      } else {
        formData.append("imageUrl", existingImageUrl);
      }

      try {
        const url = id ? `/api/key-technologies/${id}` : "/api/key-technologies";
        const method = id ? "PUT" : "POST";

        const res = await fetch(url, {
          method,
          body: formData, // No Content-Type header when sending FormData
        });

        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          throw new Error(data.message || "Failed to save technology");
        }

        await fetchTechnologies();
        techForm.reset();
        document.getElementById("techId").value = "";
        document.getElementById("order").value = "0";
        document.getElementById("existingImageUrl").value = "";
        document.getElementById("imagePreviewContainer").classList.add("hidden");
        document.getElementById("imagePreview").src = "";
        
        addButton.classList.remove("hidden");
        updateButton.classList.add("hidden");
        cancelEditButton.classList.add("hidden");
      } catch (error) {
        console.error(error);
        alert(error.message || "Error saving technology");
      }
    });

    cancelEditButton.addEventListener("click", () => {
      techForm.reset();
      document.getElementById("techId").value = "";
      document.getElementById("order").value = "0";
      document.getElementById("existingImageUrl").value = "";
      document.getElementById("imagePreviewContainer").classList.add("hidden");
      document.getElementById("imagePreview").src = "";
      
      addButton.classList.remove("hidden");
      updateButton.classList.add("hidden");
      cancelEditButton.classList.add("hidden");
    });

    window.editTechnology = function (id) {
      const tech = technologies.find((t) => t._id === id);
      if (!tech) return;

      document.getElementById("techId").value = tech._id;
      document.getElementById("title").value = tech.title || "";
      document.getElementById("description").value = tech.description || "";
      document.getElementById("tags").value = (tech.tags || []).join(", ");
      document.getElementById("order").value = tech.order || 0;
      
      // Handle image preview
      document.getElementById("existingImageUrl").value = tech.imageUrl || "";
      if (tech.imageUrl) {
        document.getElementById("imagePreview").src = tech.imageUrl;
        document.getElementById("imagePreviewContainer").classList.remove("hidden");
      } else {
        document.getElementById("imagePreviewContainer").classList.add("hidden");
      }

      addButton.classList.add("hidden");
      updateButton.classList.remove("hidden");
      cancelEditButton.classList.remove("hidden");

      techForm.scrollIntoView({ behavior: "smooth" });
    };

    function applySearchFilter() {
      const term = searchInput.value.toLowerCase().trim();
      if (!term) {
        renderTechnologies(technologies);
        return;
      }

      const filtered = technologies.filter((tech) => {
        const inTitle = (tech.title || "").toLowerCase().includes(term);
        const inTags = (tech.tags || [])
          .join(" ")
          .toLowerCase()
          .includes(term);
        return inTitle || inTags;
      });

      renderTechnologies(filtered);
    }

    searchInput.addEventListener("input", applySearchFilter);

    window.confirmDelete = function (id) {
      currentDeletingId = id;
      deleteModal.classList.remove("hidden");
      deleteModal.classList.add("flex");
    };

    cancelDeleteBtn.addEventListener("click", () => {
      deleteModal.classList.add("hidden");
      deleteModal.classList.remove("flex");
      currentDeletingId = null;
    });

    confirmDeleteBtn.addEventListener("click", async () => {
      if (!currentDeletingId) return;
      try {
        const res = await fetch(`/api/key-technologies/${currentDeletingId}`, {
          method: "DELETE",
        });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          throw new Error(data.message || "Failed to delete technology");
        }
        await fetchTechnologies();
        deleteModal.classList.add("hidden");
        deleteModal.classList.remove("flex");
        currentDeletingId = null;
      } catch (error) {
        console.error(error);
        alert(error.message || "Error deleting technology");
      }
    });

    fetchTechnologies();
  </script>
</body>

</html>



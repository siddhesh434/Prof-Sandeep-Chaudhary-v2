<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard & Statistics</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    body {
      font-family: 'Inter', sans-serif;
    }

    .stat-card {
      transition: all 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
    }

    .animate-count {
      transition: all 1s ease-out;
    }
  </style>
</head>

<body class="bg-gray-50">
  <div class="flex h-screen overflow-hidden relative">
    <!-- New Collapsible Sidebar -->
    <%- include('../partials/admin-sidebar', { adminID: adminID, currentPage: '/admin' }) %>

    <!-- Overlay for mobile sidebar -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto bg-gray-50 p-4 md:p-8">
      <!-- Header -->
      <div class="flex justify-between items-center mb-8">
        <div class="flex items-center">
          <button id="mobile-menu-button" class="mr-3 text-gray-700 md:hidden">
            <i class="fas fa-bars text-xl"></i>
          </button>
          <div>
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 tracking-tight">
              Dashboard Overview
            </h1>
            <p class="text-gray-500 text-sm mt-1">Real-time statistics and system status</p>
          </div>
        </div>
        
        <div class="flex items-center space-x-4">
          <div class="bg-white px-4 py-2 rounded-full shadow-sm border border-gray-100 hidden sm:block">
            <span class="text-sm text-gray-500">Last Login: <span class="font-medium text-gray-800">Just now</span></span>
          </div>
          <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-blue-800 rounded-full flex items-center justify-center text-white font-semibold shadow-md">
            A
          </div>
        </div>
      </div>

      <!-- Stats Grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        
        <!-- Publications Stats -->
        <div class="stat-card bg-white rounded-xl shadow-sm border border-gray-100 p-5 border-l-4 border-blue-600">
          <div class="flex justify-between items-start">
            <div>
              <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Journal Publications</p>
              <h3 class="text-3xl font-bold text-gray-800 mt-2" id="pubCount">-</h3>
            </div>
            <div class="bg-blue-50 p-3 rounded-lg text-blue-600">
              <i class="fas fa-file-alt text-xl"></i>
            </div>
          </div>
          <a href="/admin/publication.html" class="mt-4 block text-sm text-blue-600 hover:text-blue-800 font-medium">View Details &rarr;</a>
        </div>

        <div class="stat-card bg-white rounded-xl shadow-sm border border-gray-100 p-5 border-l-4 border-indigo-600">
          <div class="flex justify-between items-start">
            <div>
              <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Conferences</p>
              <h3 class="text-3xl font-bold text-gray-800 mt-2" id="confCount">-</h3>
            </div>
            <div class="bg-indigo-50 p-3 rounded-lg text-indigo-600">
              <i class="fas fa-microphone text-xl"></i>
            </div>
          </div>
          <a href="/admin/conference.html" class="mt-4 block text-sm text-indigo-600 hover:text-indigo-800 font-medium">View Details &rarr;</a>
        </div>

        <div class="stat-card bg-white rounded-xl shadow-sm border border-gray-100 p-5 border-l-4 border-purple-600">
          <div class="flex justify-between items-start">
            <div>
              <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Books & Chapters</p>
              <h3 class="text-3xl font-bold text-gray-800 mt-2" id="bookCount">-</h3>
            </div>
            <div class="bg-purple-50 p-3 rounded-lg text-purple-600">
              <i class="fas fa-book text-xl"></i>
            </div>
          </div>
          <div class="flex space-x-3 mt-4">
            <a href="/admin/book.html" class="text-sm text-purple-600 hover:text-purple-800 font-medium">Books &rarr;</a>
            <span class="text-gray-300">|</span>
            <a href="/admin/chapters.html" class="text-sm text-purple-600 hover:text-purple-800 font-medium">Chapters &rarr;</a>
          </div>
        </div>

        <!-- Research Stats -->
        <div class="stat-card bg-white rounded-xl shadow-sm border border-gray-100 p-5 border-l-4 border-green-600">
          <div class="flex justify-between items-start">
            <div>
              <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Active Projects</p>
              <h3 class="text-3xl font-bold text-gray-800 mt-2" id="projCount">-</h3>
            </div>
            <div class="bg-green-50 p-3 rounded-lg text-green-600">
              <i class="fas fa-flask text-xl"></i>
            </div>
          </div>
          <a href="/admin/projects.html" class="mt-4 block text-sm text-green-600 hover:text-green-800 font-medium">View Details &rarr;</a>
        </div>

        <div class="stat-card bg-white rounded-xl shadow-sm border border-gray-100 p-5 border-l-4 border-teal-600">
          <div class="flex justify-between items-start">
            <div>
              <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Patents</p>
              <h3 class="text-3xl font-bold text-gray-800 mt-2" id="patentCount">-</h3>
            </div>
            <div class="bg-teal-50 p-3 rounded-lg text-teal-600">
              <i class="fas fa-file-signature text-xl"></i>
            </div>
          </div>
          <a href="/admin/patents.html" class="mt-4 block text-sm text-teal-600 hover:text-teal-800 font-medium">View Details &rarr;</a>
        </div>

        <div class="stat-card bg-white rounded-xl shadow-sm border border-gray-100 p-5 border-l-4 border-yellow-500">
          <div class="flex justify-between items-start">
            <div>
              <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Dissertations</p>
              <h3 class="text-3xl font-bold text-gray-800 mt-2" id="dissCount">-</h3>
            </div>
            <div class="bg-yellow-50 p-3 rounded-lg text-yellow-600">
              <i class="fas fa-user-graduate text-xl"></i>
            </div>
          </div>
          <a href="/admin/dissertations.html" class="mt-4 block text-sm text-yellow-600 hover:text-yellow-800 font-medium">View Details &rarr;</a>
        </div>

        <!-- Team Stats -->
        <div class="stat-card bg-white rounded-xl shadow-sm border border-gray-100 p-5 border-l-4 border-red-500">
          <div class="flex justify-between items-start">
            <div>
              <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Team Members</p>
              <h3 class="text-3xl font-bold text-gray-800 mt-2" id="memberCount">-</h3>
            </div>
            <div class="bg-red-50 p-3 rounded-lg text-red-600">
              <i class="fas fa-users text-xl"></i>
            </div>
          </div>
          <a href="/admin/researchMembers.html" class="mt-4 block text-sm text-red-600 hover:text-red-800 font-medium">View Details &rarr;</a>
        </div>

        <!-- Resource Stats -->
        <div class="stat-card bg-white rounded-xl shadow-sm border border-gray-100 p-5 border-l-4 border-gray-600">
          <div class="flex justify-between items-start">
            <div>
              <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Files & Resources</p>
              <h3 class="text-3xl font-bold text-gray-800 mt-2" id="fileCount">-</h3>
            </div>
            <div class="bg-gray-100 p-3 rounded-lg text-gray-600">
              <i class="fas fa-folder-open text-xl"></i>
            </div>
          </div>
          <div class="flex space-x-3 mt-4">
              <a href="/admin/files.html" class="text-sm text-gray-600 hover:text-gray-800 font-medium">Files &rarr;</a>
              <span class="text-gray-300">|</span>
              <a href="/admin/eResources.html" class="text-sm text-gray-600 hover:text-gray-800 font-medium">eResources &rarr;</a>
          </div>
        </div>

      </div>

      <!-- Quick Actions / System Info -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="md:col-span-2 bg-white rounded-xl shadow-sm border border-gray-100 p-6">
              <h3 class="font-bold text-gray-800 mb-4">Quick Shortcuts</h3>
              <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                  <a href="/admin/control.html" class="flex flex-col items-center justify-center p-4 bg-purple-50 hover:bg-purple-100 rounded-lg transition-colors group">
                      <div class="w-10 h-10 bg-purple-200 text-purple-700 rounded-full flex items-center justify-center mb-2 group-hover:bg-purple-300">
                          <i class="fas fa-sliders-h"></i>
                      </div>
                      <span class="text-sm font-medium text-gray-700">Visibility</span>
                  </a>
                  <a href="/admin/cvGenerator.html" class="flex flex-col items-center justify-center p-4 bg-red-50 hover:bg-red-100 rounded-lg transition-colors group">
                      <div class="w-10 h-10 bg-red-200 text-red-700 rounded-full flex items-center justify-center mb-2 group-hover:bg-red-300">
                          <i class="fas fa-file-pdf"></i>
                      </div>
                      <span class="text-sm font-medium text-gray-700">CV Generator</span>
                  </a>
                  <a href="/admin/files.html" class="flex flex-col items-center justify-center p-4 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors group">
                      <div class="w-10 h-10 bg-blue-200 text-blue-700 rounded-full flex items-center justify-center mb-2 group-hover:bg-blue-300">
                          <i class="fas fa-folder"></i>
                      </div>
                      <span class="text-sm font-medium text-gray-700">File Manager</span>
                  </a>
                  <a href="/admin/formData" class="flex flex-col items-center justify-center p-4 bg-yellow-50 hover:bg-yellow-100 rounded-lg transition-colors group">
                      <div class="w-10 h-10 bg-yellow-200 text-yellow-700 rounded-full flex items-center justify-center mb-2 group-hover:bg-yellow-300">
                          <i class="fas fa-ticket-alt"></i>
                      </div>
                      <span class="text-sm font-medium text-gray-700">Requests</span>
                  </a>
              </div>
          </div>
          
          <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl shadow-md text-white p-6">
              <h3 class="font-bold mb-4 flex items-center">
                  <i class="fas fa-server mr-2"></i> System Status
              </h3>
              <div class="space-y-4">
                  <div class="flex justify-between items-center border-b border-gray-700 pb-2">
                      <span class="text-gray-300">Database</span>
                      <span class="text-green-400 font-medium flex items-center"><span class="w-2 h-2 bg-green-400 rounded-full mr-2"></span> Connected</span>
                  </div>
                  <div class="flex justify-between items-center border-b border-gray-700 pb-2">
                      <span class="text-gray-300">Server Time</span>
                      <span class="text-gray-200 font-mono text-sm" id="serverTime">--:--</span>
                  </div>
                  <div class="flex justify-between items-center">
                      <span class="text-gray-300">Version</span>
                      <span class="text-blue-400 font-medium">v2.1.0</span>
                  </div>
              </div>
          </div>
      </div>
    </main>
  </div>

  <script>
    // Fetch Count Helper
    async function fetchCount(url, elementId, combine = false) {
      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error('Fetch failed');
        let data = await response.json();
        
        let count = 0;
        if (Array.isArray(data)) {
            count = data.length;
        } else if (data.bulletins) { // Handle standardized API responses if any
           count = data.bulletins.length; 
        }

        const el = document.getElementById(elementId);
        if (el) {
            if (combine) {
                // Determine if we need to add to existing count (for Books + Chapters)
                let current = parseInt(el.textContent) || 0;
                if(isNaN(current)) current = 0;
                animateValue(el, current, current + count, 1000);
            } else {
                animateValue(el, 0, count, 1000);
            }
        }
      } catch (error) {
        console.error(`Error fetching ${elementId}:`, error);
        const el = document.getElementById(elementId);
        if(el && el.textContent === '-') el.textContent = '0';
      }
    }

    // Number Animation Helper
    function animateValue(obj, start, end, duration) {
      let startTimestamp = null;
      const step = (timestamp) => {
        if (!startTimestamp) startTimestamp = timestamp;
        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
        obj.innerHTML = Math.floor(progress * (end - start) + start);
        if (progress < 1) {
          window.requestAnimationFrame(step);
        }
      };
      window.requestAnimationFrame(step);
    }

    // Server time updater
    function updateTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const dateString = now.toLocaleDateString([], { day: 'numeric', month: 'short' });
        const el = document.getElementById('serverTime');
        if(el) el.textContent = `${dateString}, ${timeString}`;
    }

    // Initialize Dashboard
    document.addEventListener('DOMContentLoaded', () => {
      // Mobile Sidebar Toggle Logic
      const mobileMenuBtn = document.getElementById('mobile-menu-button');
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebar-overlay');

      if (mobileMenuBtn && sidebar && overlay) {
        mobileMenuBtn.addEventListener('click', () => {
          sidebar.classList.remove('-translate-x-full');
          overlay.classList.remove('hidden');
          document.body.classList.add('overflow-hidden');
        });

        overlay.addEventListener('click', () => {
          sidebar.classList.add('-translate-x-full');
          overlay.classList.add('hidden');
          document.body.classList.remove('overflow-hidden');
        });
      }

      // Fetch all stats
      fetchCount('/publications', 'pubCount');
      fetchCount('/conferences', 'confCount');
      fetchCount('/projects', 'projCount');
      fetchCount('/patents', 'patentCount');
      fetchCount('/dissertations', 'dissCount');
      fetchCount('/members', 'memberCount');
      
      // Combine Books and Chapters
      fetchCount('/books', 'bookCount', true); // First fetch
      setTimeout(() => fetchCount('/chapters', 'bookCount', true), 500); // Second fetch, additive

      // Combine Files and eResources
      fetchCount('/api/files', 'fileCount', true);
      setTimeout(() => fetchCount('/api/eresources', 'fileCount', true), 500);

      // Start clock
      updateTime();
      setInterval(updateTime, 60000); // Update every minute
    });
  </script>
</body>

</html>
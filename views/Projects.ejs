<%- include('partials/header') %>

  <link rel="stylesheet" href="projects.css" />



  <!-- ... other meta tags remain the same ... -->

  <script>
    // Add this sorting function at the top of your template
    function extractEndYear(yearString) {
      if (!yearString) return 0;
      const yearStr = yearString.toString().trim();
      if (yearStr.includes('-')) {
        const parts = yearStr.split('-');
        return parseInt(parts[parts.length - 1]) || 0;
      }
      return parseInt(yearStr) || 0;
    }

    function sortProjectsByEndYear(projects) {
      return projects.sort((a, b) => {
        const endYearA = extractEndYear(a.year);
        const endYearB = extractEndYear(b.year);
        return endYearB - endYearA; // Descending order
      });
    }
  </script>

  <!-- Main Content -->
  <div class="main-wrapper">
    <div class="container">
      <div class="page-title">
        <h1>Projects</h1>
        <p class="subtitle">Research projects in various capacities</p>
      </div>


      <%
        // Sort projects by end year for each category
        const piProjects = projects
          .filter(project => project.projectType === "Sponsored Research Project" && project.role === "As Principal Investigator")
          .sort((a, b) => {
            const getEndYear = (yearString) => {
              if (!yearString) return 0;
              const yearStr = yearString.toString().trim();
              if (yearStr.includes('-')) {
                const parts = yearStr.split('-');
                return parseInt(parts[parts.length - 1]) || 0;
              }
              return parseInt(yearStr) || 0;
            };
            return getEndYear(b.year) - getEndYear(a.year);
          });

        const copiProjects = projects
          .filter(project => project.projectType === "Sponsored Research Project" && project.role === "As Co-Principal Investigator")
          .sort((a, b) => {
            const getEndYear = (yearString) => {
              if (!yearString) return 0;
              const yearStr = yearString.toString().trim();
              if (yearStr.includes('-')) {
                const parts = yearStr.split('-');
                return parseInt(parts[parts.length - 1]) || 0;
              }
              return parseInt(yearStr) || 0;
            };
            return getEndYear(b.year) - getEndYear(a.year);
          });

        const scientistMentorProjects = projects
          .filter(project => project.projectType === "Sponsored Research Project" && project.role === "As Scientist Mentor")
          .sort((a, b) => {
            const getEndYear = (yearString) => {
              if (!yearString) return 0;
              const yearStr = yearString.toString().trim();
              if (yearStr.includes('-')) {
                const parts = yearStr.split('-');
                return parseInt(parts[parts.length - 1]) || 0;
              }
              return parseInt(yearStr) || 0;
            };
            return getEndYear(b.year) - getEndYear(a.year);
          });

        const guideProjects = projects
          .filter(project => project.projectType === "Sponsored Research Project" && project.role === "As a Guide")
          .sort((a, b) => {
            const getEndYear = (yearString) => {
              if (!yearString) return 0;
              const yearStr = yearString.toString().trim();
              if (yearStr.includes('-')) {
                const parts = yearStr.split('-');
                return parseInt(parts[parts.length - 1]) || 0;
              }
              return parseInt(yearStr) || 0;
            };
            return getEndYear(b.year) - getEndYear(a.year);
          });

        const consultancyProjects = projects
          .filter(project => project.projectType === "Consultancy Project")
          .sort((a, b) => {
            const getEndYear = (yearString) => {
              if (!yearString) return 0;
              const yearStr = yearString.toString().trim();
              if (yearStr.includes('-')) {
                const parts = yearStr.split('-');
                return parseInt(parts[parts.length - 1]) || 0;
              }
              return parseInt(yearStr) || 0;
            };
            return getEndYear(b.year) - getEndYear(a.year);
          });

        const otherProjects = projects
          .filter(project => project.projectType === "Others")
          .sort((a, b) => {
            const getEndYear = (yearString) => {
              if (!yearString) return 0;
              const yearStr = yearString.toString().trim();
              if (yearStr.includes('-')) {
                const parts = yearStr.split('-');
                return parseInt(parts[parts.length - 1]) || 0;
              }
              return parseInt(yearStr) || 0;
            };
            return getEndYear(b.year) - getEndYear(a.year);
          });
      %>

      <% if (settings.showProjects) { %>
        <!-- Project Summary -->
        <div class="project-summary">
          <div class="summary-card">
            <div class="summary-number" id="total-projects">
              <%= projects.filter(project => project.projectType === "Sponsored Research Project").length %>
            </div>
            <div class="summary-title">Total Sponsored Research Projects</div>
          </div>

          <div class="summary-card">
            <div class="summary-number" id="pi-projects">
              <%= piProjects.length %>
            </div>
            <div class="summary-title">As Principal Investigator</div>
          </div>

          <div class="summary-card">
            <div class="summary-number" id="copi-projects">
              <%= copiProjects.length %>
            </div>
            <div class="summary-title">As Co-Principal Investigator</div>
          </div>

          <div class="summary-card">
            <div class="summary-number" id="scientist-mentor-projects">
              <%= scientistMentorProjects.length %>
            </div>
            <div class="summary-title">As Scientist Mentor</div>
          </div>

          <div class="summary-card">
            <div class="summary-number" id="guide-projects">
              <%= guideProjects.length %>
            </div>
            <div class="summary-title">As a Guide</div>
          </div>
        </div>
      <% } %>

      <!-- Sponsored Research Projects Section -->
      <div class="project-section">
        <div class="section-title">
          <h2>Sponsored Research Projects</h2>
        </div>

        <!-- Principal Investigator Projects -->
        <div class="role-subsection">
          <h3>As Principal Investigator</h3>
          <div class="table-controls">
            <div class="entries-selector">
              <label for="entries-select-pi">Show</label>
              <select id="entries-select-pi" class="entries-select">
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
              <span>entries</span>
            </div>
            <div class="search-container">
              <input type="text" id="pi-search" placeholder="Search Principal Investigator projects..."
                class="search-input" />
              <button id="search-btn-pi" class="search-button">
                <i class="fas fa-search"></i>
              </button>
            </div>
          </div>

          <div class="table-wrapper">
            <table class="project-table" id="pi-table">
              <thead>
                <tr style="text-transform: none;">
                  <th>Title</th>
                  <th>Year</th>
                  <th>Funded by</th>
                  <th>Collaborator(s)</th>
                </tr>
              </thead>
              <tbody id="pi-body">
                <% piProjects.forEach((project, index) => { %>
                  <tr class="pi-row" data-index="<%= index %>">
                    <td><%= project.title %></td>
                    <td><%= project.year %></td>
                    <td><%= project.funded %></td>
                    <td><%= project.collaborator %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>

          <div class="pagination-container">
            <div class="pagination-info">
              Showing <span id="showing-start-pi">1</span> to
              <span id="showing-end-pi">5</span> of
              <span id="total-entries-pi">0</span> entries
            </div>
            <div class="pagination-controls" id="pagination-controls-pi">
              <!-- Pagination buttons will be dynamically generated -->
            </div>
          </div>
        </div>

        <!-- Co-Principal Investigator Projects -->
        <div class="role-subsection">
          <h3>As Co-Principal Investigator</h3>
          <div class="table-controls">
            <div class="entries-selector">
              <label for="entries-select-copi">Show</label>
              <select id="entries-select-copi" class="entries-select">
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
              <span>entries</span>
            </div>
            <div class="search-container">
              <input type="text" id="copi-search" placeholder="Search Co-Principal Investigator projects..."
                class="search-input" />
              <button id="search-btn-copi" class="search-button">
                <i class="fas fa-search"></i>
              </button>
            </div>
          </div>

          <div class="table-wrapper">
            <table class="project-table" id="copi-table">
              <thead>
                <tr>
                  <th>Title</th>
                  <th>Year</th>
                  <th>Funded by</th>
                  <th>Collaborator(s)</th>
                </tr>
              </thead>
              <tbody id="copi-body">
                <% copiProjects.forEach((project, index) => { %>
                  <tr class="copi-row" data-index="<%= index %>">
                    <td><%= project.title %></td>
                    <td><%= project.year %></td>
                    <td><%= project.funded %></td>
                    <td><%= project.collaborator %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>

          <div class="pagination-container">
            <div class="pagination-info">
              Showing <span id="showing-start-copi">1</span> to
              <span id="showing-end-copi">5</span> of
              <span id="total-entries-copi">0</span> entries
            </div>
            <div class="pagination-controls" id="pagination-controls-copi">
              <!-- Pagination buttons will be dynamically generated -->
            </div>
          </div>
        </div>

        <!-- Scientist Mentor Projects -->
        <div class="role-subsection">
          <h3>As Scientist Mentor</h3>
          <div class="table-controls">
            <div class="entries-selector">
              <label for="entries-select-scientist-mentor">Show</label>
              <select id="entries-select-scientist-mentor" class="entries-select">
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
              <span>entries</span>
            </div>
            <div class="search-container">
              <input type="text" id="scientist-mentor-search" placeholder="Search Scientist Mentor projects..."
                class="search-input" />
              <button id="search-btn-scientist-mentor" class="search-button">
                <i class="fas fa-search"></i>
              </button>
            </div>
          </div>

          <div class="table-wrapper">
            <table class="project-table" id="scientist-mentor-table">
              <thead>
                <tr style="text-transform: none;">
                  <th>Title</th>
                  <th>Year</th>
                  <th>Funded by</th>
                  <th>Collaborator(s)</th>
                </tr>
              </thead>
              <tbody id="scientist-mentor-body">
                <% scientistMentorProjects.forEach((project, index) => { %>
                  <tr class="scientist-mentor-row" data-index="<%= index %>">
                    <td><%= project.title %></td>
                    <td><%= project.year %></td>
                    <td><%= project.funded %></td>
                    <td><%= project.collaborator %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>

          <div class="pagination-container">
            <div class="pagination-info">
              Showing <span id="showing-start-scientist-mentor">1</span> to
              <span id="showing-end-scientist-mentor">5</span> of
              <span id="total-entries-scientist-mentor">0</span> entries
            </div>
            <div class="pagination-controls" id="pagination-controls-scientist-mentor">
              <!-- Pagination buttons will be dynamically generated -->
            </div>
          </div>
        </div>

        <!-- Guide Projects -->
        <div class="role-subsection">
          <h3>As a Guide</h3>
          <div class="table-controls">
            <div class="entries-selector">
              <label for="entries-select-guide">Show</label>
              <select id="entries-select-guide" class="entries-select">
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
              <span>entries</span>
            </div>
            <div class="search-container">
              <input type="text" id="guide-search" placeholder="Search Guide projects..." class="search-input" />
              <button id="search-btn-guide" class="search-button">
                <i class="fas fa-search"></i>
              </button>
            </div>
          </div>

          <div class="table-wrapper">
            <table class="project-table" id="guide-table">
              <thead>
                <tr style="text-transform: none;">
                  <th>Title</th>
                  <th>Year</th>
                  <th>Funded by</th>
                  <th>Collaborator(s)</th>
                </tr>
              </thead>
              <tbody id="guide-body">
                <% guideProjects.forEach((project, index) => { %>
                  <tr class="guide-row" data-index="<%= index %>">
                    <td><%= project.title %></td>
                    <td><%= project.year %></td>
                    <td><%= project.funded %></td>
                    <td><%= project.collaborator %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>

          <div class="pagination-container">
            <div class="pagination-info">
              Showing <span id="showing-start-guide">1</span> to
              <span id="showing-end-guide">5</span> of
              <span id="total-entries-guide">0</span> entries
            </div>
            <div class="pagination-controls" id="pagination-controls-guide">
              <!-- Pagination buttons will be dynamically generated -->
            </div>
          </div>
        </div>
      </div>

      <!-- Consultancy Projects Section -->
      <!-- <div class="project-section">
        <div class="section-title">
          <h2>Consultancy Projects</h2>
        </div>
        <h3 style="color: var(--primary-color)">
          Handled more than 150 consultancy Projects as PI of amount more than INR
          35 million.
        </h3>
        <h4 style="text-decoration: underline">Major Projects handled-</h4>
        
        <div class="table-controls">
          <div class="entries-selector">
            <label for="entries-select-consultancy">Show</label>
            <select id="entries-select-consultancy" class="entries-select">
              <option value="5">5</option>
              <option value="10">10</option>
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
            <span>entries</span>
          </div>
          <div class="search-container">
            <input type="text" id="consultancy-search" placeholder="Search projects..." class="search-input" />
            <button id="search-btn-consultancy" class="search-button">
              <i class="fas fa-search"></i>
            </button>
          </div>
        </div>

        <div class="table-wrapper">
          <table class="project-table" id="consultancy-table">
            <thead>
              <tr style="text-transform: none;">
                <th>Title</th>
                <th>Year</th>
                <th>Funded by</th>
                <th>Collaborator</th>
                <th>Role</th>
              </tr>
            </thead>
            <tbody id="consultancy-body">
              <% consultancyProjects.forEach((project, index) => { %>
                <tr class="consultancy-row" data-index="<%= index %>">
                  <td><%= project.title %></td>
                  <td><%= project.year %></td>
                  <td><%= project.funded %></td>
                  <td><%= project.collaborator %></td>
                  <td><%= project.role %></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>

        <div class="pagination-container">
          <div class="pagination-info">
            Showing <span id="showing-start-consultancy">1</span> to
            <span id="showing-end-consultancy">5</span> of
            <span id="total-entries-consultancy">0</span> entries
          </div>
          <div class="pagination-controls" id="pagination-controls-consultancy">
          </div>
        </div>
      </div> -->

      <!-- Others Projects Section -->
      <!-- <div class="project-section">
        <div class="section-title">
          <h2>Other Projects</h2>
        </div>
        <div class="table-controls">
          <div class="entries-selector">
            <label for="entries-select-others">Show</label>
            <select id="entries-select-others" class="entries-select">
              <option value="5">5</option>
              <option value="10">10</option>
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
            <span>entries</span>
          </div>
          <div class="search-container">
            <input type="text" id="others-search" placeholder="Search projects..." class="search-input" />
            <button id="search-btn-others" class="search-button">
              <i class="fas fa-search"></i>
            </button>
          </div>
        </div>

        <div class="table-wrapper">
          <table class="project-table" id="others-table">
            <thead>
              <tr style="text-transform: none;">
                <th>Title</th>
                <th>Year</th>
                <th>Funded by</th>
                <th>Collaborator</th>
                <th>Role</th>
              </tr>
            </thead>
            <tbody id="others-body">
              <% otherProjects.forEach((project, index) => { %>
                <tr class="others-row" data-index="<%= index %>">
                  <td><%= project.title %></td>
                  <td><%= project.year %></td>
                  <td><%= project.funded %></td>
                  <td><%= project.collaborator %></td>
                  <td><%= project.role %></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
        <div class="pagination-container">
          <div class="pagination-info">
            Showing <span id="showing-start-others">1</span> to
            <span id="showing-end-others">5</span> of
            <span id="total-entries-others">0</span> entries
          </div>
          <div class="pagination-controls" id="pagination-controls-others">
          </div>
        </div>
      </div> -->
    </div>
  </div>
  <script>
    // Pagination and Search Functionality
    document.addEventListener("DOMContentLoaded", function () {
      const roles = ["pi", "copi", "scientist-mentor", "guide"];

      roles.forEach((role) => {
        const table = document.getElementById(`${role}-table`);
        const tbody = document.getElementById(`${role}-body`);
        const searchInput = document.getElementById(`${role}-search`);
        const entriesSelect = document.getElementById(`entries-select-${role}`);
        const showingStart = document.getElementById(`showing-start-${role}`);
        const showingEnd = document.getElementById(`showing-end-${role}`);
        const totalEntries = document.getElementById(`total-entries-${role}`);
        const paginationControls = document.getElementById(
          `pagination-controls-${role}`
        );

        if (!tbody || !paginationControls) return;

        let currentPage = 1;
        let rowsPerPage = 5;
        // Check for tbody again (redundant but safe)
        if (!tbody) return; 
        
        // Note: querySelectorAll returns a NodeList. Array.from is good.
        // But if tbody is null, it crashes. We added check above.
        let filteredRows = Array.from(tbody.querySelectorAll("tr"));

        function updatePagination() {
          // Clear previous pagination controls
          paginationControls.innerHTML = "";

          // Calculate total pages
          const totalPages = Math.ceil(filteredRows.length / rowsPerPage);

          // Create pagination buttons
          for (let i = 1; i <= totalPages; i++) {
            const pageButton = document.createElement("button");
            pageButton.textContent = i;
            pageButton.classList.add("pagination-button");
            // Highlight active page
            if (i === currentPage) {
                 pageButton.style.backgroundColor = 'var(--primary-color)';
                 pageButton.style.color = 'white';
            }
            pageButton.addEventListener("click", () => {
              currentPage = i;
              displayRows();
            });
            paginationControls.appendChild(pageButton);
          }

          // Update showing entries info
          const startIndex = (currentPage - 1) * rowsPerPage + 1;
          const endIndex = Math.min(
            startIndex + rowsPerPage - 1,
            filteredRows.length
          );

          showingStart.textContent = filteredRows.length > 0 ? startIndex : 0;
          showingEnd.textContent = endIndex;
          totalEntries.textContent = filteredRows.length;
        }

        function displayRows() {
          // Hide all rows first
          tbody
            .querySelectorAll("tr")
            .forEach((row) => (row.style.display = "none"));

          // Calculate start and end indices for current page
          const startIndex = (currentPage - 1) * rowsPerPage;
          const endIndex = startIndex + rowsPerPage;

          // Show rows for current page
          filteredRows
            .slice(startIndex, endIndex)
            .forEach((row) => (row.style.display = ""));

          // Update pagination controls
          updatePagination();
        }

        // Entries per page selector
        entriesSelect.addEventListener("change", function () {
          rowsPerPage = parseInt(this.value);
          currentPage = 1;
          displayRows();
        });

        // Search functionality
        searchInput.addEventListener("input", function () {
          const searchTerm = this.value.toLowerCase();

          // Filter rows based on search term
          filteredRows = Array.from(tbody.querySelectorAll("tr")).filter(
            (row) => {
              const rowText = row.textContent.toLowerCase();
              return rowText.includes(searchTerm);
            }
          );

          currentPage = 1;
          displayRows();
        });

        // Initial display
        displayRows();
      });
    });

  </script>
<%- include('partials/footer') %>



